<app-navbar></app-navbar>

<div class="product-add-page">
  <div class="product-add-shell">
    <div class="product-add-hero">
      <div>
        <span class="eyebrow">Panel / Productos</span>
        <h2>Crear producto</h2>
        <p>Configurá la ficha, subí la imagen y agregá variantes con su stock en un flujo claro.</p>
      </div>
      <div class="hero-card ds-card">
        <span class="hero-kicker">Checklist</span>
        <ul>
          <li>Datos básicos</li>
          <li>Imagen del producto</li>
          <li>Variantes y stock</li>
        </ul>
      </div>
    </div>

    <form (ngSubmit)="addProduct()" enctype="multipart/form-data" class="product-form">
      <section class="form-section">
        <div class="section-head">
          <div>
            <h3>Información general</h3>
            <p>Definí la categoría, el nombre visible y el precio final.</p>
          </div>
          <span class="section-chip">Paso 1</span>
        </div>

        <div class="form-grid">
          <div class="field-block">
            <label for="category">Elija una categoría</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <mat-select [(ngModel)]="categoryId" name="category" id="category" (selectionChange)="handleCategoryChange()" required>
                <mat-option *ngFor="let categoria of categories" [value]="categoria.id">
                  {{ categoria.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="nombre">Nombre</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="name" type="text" id="nombre" name="nombre" placeholder="Nombre del producto" autocomplete="off" required>
            </mat-form-field>
          </div>

          <div class="field-block span-2">
            <label for="descripcion">Descripción</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <textarea matInput [(ngModel)]="description" id="descripcion" name="descripcion" placeholder="Breve descripción y detalles" required></textarea>
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="priceOverride">Precio personalizado</label>
            <div class="flex items-center gap-3">
              <input type="checkbox" id="priceOverride" name="priceOverride" [(ngModel)]="priceOverride" (change)="handlePriceOverrideChange()">
              <span class="text-sm text-secondary">Si está desactivado, se usa el precio de la categoría.</span>
            </div>
          </div>

          <div class="field-block">
            <label for="precio">Precio</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="price" type="number" step="any" id="precio" name="precio" placeholder="0.00" autocomplete="off" [readonly]="!priceOverride">
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="code">Cuotas</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="code" (input)="refreshAllSkus()" type="text" step="any" id="code" name="code" placeholder="Cantidad de cuotas" autocomplete="off" required>
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="sellOnline">Disponible en tienda online</label>
            <div class="flex items-center gap-3">
              <input type="checkbox" id="sellOnline" name="sellOnline" [(ngModel)]="sellOnline">
              <span class="text-sm text-secondary">Si lo desactivás, solo se vende en admin.</span>
            </div>
          </div>

          <div class="field-block">
            <label for="deliveryType">Tipo de entrega</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <mat-select [(ngModel)]="deliveryType" id="deliveryType" name="deliveryType">
                <mat-option value="IMMEDIATE">Inmediata</mat-option>
                <mat-option value="DELAYED">Demorada</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="estimatedDeliveryDays">Demora (días)</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="estimatedDeliveryDays" id="estimatedDeliveryDays" name="estimatedDeliveryDays" type="number" min="0" placeholder="0">
            </mat-form-field>
          </div>

          <div class="field-block">
            <label for="estimatedDeliveryDate">Fecha estimada</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="estimatedDeliveryDate" id="estimatedDeliveryDate" name="estimatedDeliveryDate" type="date">
            </mat-form-field>
          </div>

          <div class="field-block span-2">
            <label for="deliveryNote">Nota de entrega</label>
            <mat-form-field appearance="outline" class="w-full modern-field">
              <input matInput [(ngModel)]="deliveryNote" id="deliveryNote" name="deliveryNote" placeholder="Ej: fabricación a pedido">
            </mat-form-field>
          </div>
        </div>
      </section>

      <section class="form-section media-section">
        <div class="section-head">
          <div>
            <h3>Imagen principal</h3>
            <p>Podés subir varias imágenes. La primera será la portada.</p>
          </div>
          <span class="section-chip">Paso 2</span>
        </div>

        <div class="upload-box">
          <div>
            <h4>Arrastrá tus archivos o hacé click</h4>
            <p>Formatos recomendados: JPG o PNG · 1200×1200 px.</p>
          </div>
          <div class="flex items-center gap-3">
            <label class="upload-action" for="img">Seleccionar imágenes</label>
            <span class="text-xs text-gray-500">{{ selectedImagesLabel }}</span>
          </div>
          <input type="file" id="img" (change)="onFileSelected($event)" multiple>
        </div>
      </section>

      <section class="form-section variants-section">
        <div class="section-head">
          <div>
            <h3>Variantes</h3>
            <p>Personalizá talla, color, material y stock para cada combinación.</p>
          </div>
          <button type="button" class="button-item button-item--outline button-item--sm" (click)="addVariant()">Agregar variante</button>
        </div>

        <div class="variants-list">
          <div *ngFor="let variant of variants; let i = index" class="variant-card">
            <div class="variant-head">
              <div>
                <span class="variant-index">Variante {{ i + 1 }}</span>
                <p>Completá los datos clave para inventario y ventas.</p>
              </div>
              <button type="button" class="button-item button-item--danger button-item--sm" (click)="removeVariant(i)" *ngIf="variants.length > 1">Eliminar</button>
            </div>

            <div class="variant-grid">
              <div class="field-stack">
                <label class="field-label" for="size-{{i}}">Talle</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.size" (input)="updateSku(i)" id="size-{{i}}" name="size-{{i}}" placeholder="A1, A2..." required>
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="color-{{i}}">Color</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.color" (input)="updateSku(i)" id="color-{{i}}" name="color-{{i}}" placeholder="blanco / azul / negro" required>
                </mat-form-field>
              </div>

              <div class="field-stack" *ngIf="isKimonoSelected()">
                <label class="field-label" for="gsm-{{i}}">GSM</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.gsm" (input)="updateSku(i)" id="gsm-{{i}}" name="gsm-{{i}}" type="number" placeholder="450">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="material-{{i}}">Material</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.material" id="material-{{i}}" name="material-{{i}}" placeholder="Pearl Weave / Ripstop">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="usage-{{i}}">Uso</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.usage" id="usage-{{i}}" name="usage-{{i}}" placeholder="entrenamiento / competencia">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="sku-{{i}}">SKU</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.sku" (input)="markSkuManual(i)" id="sku-{{i}}" name="sku-{{i}}" placeholder="LB-CL-A2-BLK" required>
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="stockCurrent-{{i}}">Stock actual</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.stockCurrent" id="stockCurrent-{{i}}" name="stockCurrent-{{i}}" type="number" min="0">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="stockMinimum-{{i}}">Stock mínimo</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.stockMinimum" id="stockMinimum-{{i}}" name="stockMinimum-{{i}}" type="number" min="0">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="priceRetail-{{i}}">Precio minorista</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.priceRetail" id="priceRetail-{{i}}" name="priceRetail-{{i}}" type="number" min="0" step="any">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="priceWholesale-{{i}}">Precio mayorista</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.priceWholesale" id="priceWholesale-{{i}}" name="priceWholesale-{{i}}" type="number" min="0" step="any">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="deliveryTypeVariant-{{i}}">Entrega</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <mat-select [(ngModel)]="variant.deliveryType" id="deliveryTypeVariant-{{i}}" name="deliveryTypeVariant-{{i}}">
                    <mat-option value="IMMEDIATE">Inmediata</mat-option>
                    <mat-option value="DELAYED">Demorada</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="estimatedDaysVariant-{{i}}">Demora (días)</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.estimatedDeliveryDays" id="estimatedDaysVariant-{{i}}" name="estimatedDaysVariant-{{i}}" type="number" min="0">
                </mat-form-field>
              </div>

              <div class="field-stack">
                <label class="field-label" for="estimatedDateVariant-{{i}}">Fecha estimada</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.estimatedDeliveryDate" id="estimatedDateVariant-{{i}}" name="estimatedDateVariant-{{i}}" type="date">
                </mat-form-field>
              </div>

              <div class="field-stack span-2">
                <label class="field-label" for="deliveryNoteVariant-{{i}}">Nota de entrega</label>
                <mat-form-field appearance="outline" class="w-full modern-field">
                  <input matInput [(ngModel)]="variant.deliveryNote" id="deliveryNoteVariant-{{i}}" name="deliveryNoteVariant-{{i}}" placeholder="Detalle de demora">
                </mat-form-field>
              </div>
            </div>

            <div class="variant-footer">
              <div class="field-stack compact">
                <label class="field-label" for="active-{{i}}">Activo</label>
                <mat-form-field appearance="outline" class="w-40 modern-field">
                  <mat-select [(ngModel)]="variant.active" id="active-{{i}}" name="active-{{i}}">
                    <mat-option [value]="true">Sí</mat-option>
                    <mat-option [value]="false">No</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <div class="field-stack compact">
                <label class="field-label" for="sellOnlineVariant-{{i}}">Vender online</label>
                <mat-form-field appearance="outline" class="w-40 modern-field">
                  <mat-select [(ngModel)]="variant.sellOnline" id="sellOnlineVariant-{{i}}" name="sellOnlineVariant-{{i}}">
                    <mat-option [value]="true">Sí</mat-option>
                    <mat-option [value]="false">No</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              <span class="variant-hint">Solo se muestra en tienda si está activo.</span>
            </div>
          </div>
        </div>
      </section>

      <div class="form-actions">
        <button type="submit" class="button-item">Guardar producto</button>
      </div>
    </form>
  </div>
</div>

<app-footer></app-footer>
  
