<app-navbar></app-navbar>

<div class="max-w-[1200px] mx-auto px-4 py-10">
  <div class="grid gap-8 lg:grid-cols-[2fr,1fr]">
    <div class="ds-card">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">Carrito</h2>
      <div *ngIf="hasDelayedItems" class="mb-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
        Algunos productos de tu carrito tienen entrega diferida.
      </div>

      <div class="space-y-5 md:hidden">
        <div *ngIf="items.length === 0" class="ux-empty">
          Tu carrito está vacío. Explorá productos y agregá tu primer ítem.
        </div>
        <div *ngFor="let item of items" class="ds-card">
          <div class="flex gap-4">
            <img
              [src]="item.imageUrl || 'assets/bjj/kimono.png'"
              [alt]="item.productName"
              class="h-28 w-28 rounded-xl object-cover border border-black/10"
            />
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900">{{ item.productName }}</h3>
              <p class="text-sm text-gray-600 mt-1">
                Talle: <span class="font-medium text-gray-900">{{ item.size || '—' }}</span>
              </p>
              <p class="text-sm text-gray-600">
                Color: <span class="font-medium text-gray-900">{{ item.color || '—' }}</span>
              </p>
              <p class="text-sm text-gray-600">
                Precio unitario:
                <span class="font-semibold text-gray-900">{{ item.price | currency: 'ARS' : 'symbol-narrow' }}</span>
              </p>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-between gap-3">
            <div class="flex items-center rounded-full border border-divider bg-surface px-2 py-1">
              <button class="btn-icon" (click)="decreaseQuantity(item)">−</button>
              <span class="w-10 text-center font-semibold text-main">{{ item.quantity }}</span>
              <button class="btn-icon" (click)="increaseQuantity(item)">+</button>
            </div>
            <div class="text-right">
              <p class="text-xs uppercase tracking-wide text-gray-500">Subtotal</p>
              <p class="text-lg font-semibold text-gray-900">
                {{ item.getTotalPriceItem() | currency: 'ARS' : 'symbol-narrow' }}
              </p>
            </div>
          </div>
          <p *ngIf="getDeliveryLabel(item)" class="mt-3 text-xs text-amber-700">
            {{ getDeliveryLabel(item) }}
          </p>

          <button
            class="button-item button-item--danger button-item--sm w-full mt-4"
            (click)="deleteItemCart(item.productVariantId)"
          >
            Eliminar producto
          </button>
        </div>
      </div>

      <div class="hidden md:block">
        <div class="overflow-x-auto">
          <div *ngIf="items.length === 0" class="ux-empty">Tu carrito está vacío.</div>
          <table class="table-shell">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio unitario</th>
                <th>Subtotal</th>
                <th>Eliminar</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of items">
                <td>
                  <div class="flex items-center gap-3">
                    <img
                      [src]="item.imageUrl || 'assets/bjj/kimono.png'"
                      [alt]="item.productName"
                      class="h-14 w-14 rounded-lg object-cover border border-black/10"
                    />
                    <div>
                      <p class="font-semibold text-gray-900">{{ item.productName }}</p>
                      <p class="text-sm text-gray-600">Talle: {{ item.size || '—' }} · Color: {{ item.color || '—' }}</p>
                      <p *ngIf="getDeliveryLabel(item)" class="text-xs text-amber-700">{{ getDeliveryLabel(item) }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="flex items-center gap-2">
                    <button class="btn-icon" (click)="decreaseQuantity(item)">−</button>
                    <span class="w-8 text-center font-semibold">{{ item.quantity }}</span>
                    <button class="btn-icon" (click)="increaseQuantity(item)">+</button>
                  </div>
                </td>
                <td>{{ item.price | currency: 'ARS' : 'symbol-narrow' }}</td>
                <td>{{ item.getTotalPriceItem() | currency: 'ARS' : 'symbol-narrow' }}</td>
                <td>
                  <button
                    class="button-item button-item--outline button-item--sm"
                    (click)="deleteItemCart(item.productVariantId)"
                  >
                    Quitar
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="mt-8" *ngIf="!isLoggedIn">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Finalizar compra</h3>
        <div class="flex gap-3 mb-6">
          <button class="btn-toggle" [class.btn-toggle--active]="!isRegisterMode" (click)="isRegisterMode = false">Ya tengo cuenta</button>
          <button class="btn-toggle" [class.btn-toggle--active]="isRegisterMode" (click)="isRegisterMode = true">Crear cuenta</button>
        </div>

        <div *ngIf="!isRegisterMode" class="grid gap-4 md:grid-cols-2">
          <input [(ngModel)]="loginEmail" type="email" class="input-item" placeholder="Email" />
          <input [(ngModel)]="loginPassword" type="password" class="input-item" placeholder="Contraseña" />
          <button class="button-item w-full md:col-span-2" (click)="login()">Ingresar</button>
        </div>

        <div *ngIf="isRegisterMode" class="grid gap-4 md:grid-cols-2">
          <input [(ngModel)]="registerName" type="text" class="input-item" placeholder="Nombre" />
          <input [(ngModel)]="registerSurname" type="text" class="input-item" placeholder="Apellido" />
          <input [(ngModel)]="registerEmail" type="email" class="input-item md:col-span-2" placeholder="Email" />
          <input [(ngModel)]="registerCellphone" type="text" class="input-item" placeholder="Teléfono" />
          <input [(ngModel)]="registerAddress" type="text" class="input-item" placeholder="Dirección (opcional)" />
          <p class="text-xs text-gray-500 md:col-span-2">Tu teléfono se usará como contraseña para este acceso.</p>
          <button class="button-item w-full md:col-span-2" (click)="register()">Crear cuenta y continuar</button>
        </div>
      </div>
    </div>

    <div class="space-y-6">
      <div class="ds-card md:sticky md:top-6">
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Resumen</h2>
        <div class="text-lg font-semibold text-gray-700 mb-4">
          Total: {{ totalCart | currency: 'ARS' : 'symbol-narrow' }}
        </div>
        <p *ngIf="getGlobalDeliveryMessage()" class="text-sm text-amber-700 mb-2">
          {{ getGlobalDeliveryMessage() }}
        </p>
        <p class="text-sm text-gray-500 mb-4">Envío a coordinar.</p>
        <button
          class="button-item w-full"
          (click)="generateOrder()"
          [disabled]="isSubmitting || !!orderCreated"
        >
          {{ isSubmitting ? 'Procesando...' : 'Finalizar compra' }}
        </button>
        <p class="text-xs text-gray-500 mt-4">Pago por transferencia. Confirmación manual.</p>
        <p class="text-xs text-gray-500">Reservamos tu producto por 30 minutos mientras realizás el pago.</p>
      </div>

      <div *ngIf="orderCreated" class="ds-card" style="background: var(--brand-black); color: var(--btn-primary-text);">
        <h3 class="text-xl font-semibold mb-4">Datos para transferencia</h3>
        <div class="text-sm text-gray-200 space-y-2">
          <p><strong>Alias:</strong> {{ environment.transferAlias }}</p>
          <p><strong>CBU:</strong> {{ environment.transferCbu }}</p>
          <p><strong>Banco:</strong> {{ environment.transferBank }}</p>
          <p><strong>Titular:</strong> {{ environment.transferHolder }}</p>
          <p><strong>Orden:</strong> #{{ orderCreated.id }}</p>
          <p><strong>Monto:</strong> {{ totalCart | currency: 'ARS' : 'symbol-narrow' }}</p>
        </div>
        <button class="button-item w-full mt-6" (click)="sendWhatsapp()">
          Enviar comprobante por WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>
<app-footer></app-footer>
